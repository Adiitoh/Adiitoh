<%- include(\'../partials/header\') %>

<div class="pending-container min-vh-100 d-flex align-items-center">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-6 col-md-8">
                <div class="pending-card card shadow-lg border-0">
                    <div class="card-body p-5 text-center">
                        <!-- Pending Icon -->
                        <div class="pending-icon mb-4">
                            <div class="icon-wrapper">
                                <i class="bi bi-clock-history text-warning" style="font-size: 4rem;"></i>
                                <div class="pulse-ring"></div>
                            </div>
                        </div>

                        <!-- Title -->
                        <h2 class="fw-bold text-dark mb-3">Account Pending Approval</h2>

                        <!-- Message -->
                        <p class="lead text-muted mb-4">
                            Thank you for registering! Your account is currently pending approval from an administrator.
                        </p>

                        <!-- User Info -->
                        <% if (user) { %>
                            <div class="user-info bg-light rounded p-3 mb-4">
                                <div class="d-flex align-items-center justify-content-center">
                                    <div class="user-avatar me-3">
                                        <div class="bg-warning rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                            <i class="bi bi-person-fill text-white fs-4"></i>
                                        </div>
                                    </div>
                                    <div class="text-start">
                                        <h6 class="mb-1 fw-semibold"><%= user.first_name %> <%= user.last_name %></h6>
                                        <p class="mb-1 text-muted"><%= user.email %></p>
                                        <span class="badge bg-warning">
                                            <i class="bi bi-clock me-1"></i>
                                            <%= user.role.charAt(0).toUpperCase() + user.role.slice(1) %> - Pending
                                        </span>
                                    </div>
                                </div>
                            </div>
                        <% } %>

                        <!-- Status Steps -->
                        <div class="status-steps mb-4">
                            <div class="row g-3">
                                <div class="col-4">
                                    <div class="step completed">
                                        <div class="step-icon bg-success text-white rounded-circle mx-auto mb-2">
                                            <i class="bi bi-check"></i>
                                        </div>
                                        <small class="text-success fw-semibold">Registered</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="step active">
                                        <div class="step-icon bg-warning text-white rounded-circle mx-auto mb-2">
                                            <i class="bi bi-clock"></i>
                                        </div>
                                        <small class="text-warning fw-semibold">Pending</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="step">
                                        <div class="step-icon bg-light text-muted rounded-circle mx-auto mb-2">
                                            <i class="bi bi-check-circle"></i>
                                        </div>
                                        <small class="text-muted">Approved</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Progress Line -->
                            <div class="progress-line mt-3">
                                <div class="progress" style="height: 4px;">
                                    <div class="progress-bar bg-warning" style="width: 50%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Information -->
                        <div class="info-section">
                            <h5 class="fw-semibold mb-3">What happens next?</h5>
                            <div class="row g-3 text-start">
                                <div class="col-md-6">
                                    <div class="info-item">
                                        <i class="bi bi-envelope-check text-primary me-2"></i>
                                        <small>You'll receive an email notification once approved</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-item">
                                        <i class="bi bi-speedometer2 text-success me-2"></i>
                                        <small>Access to your dashboard will be granted</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-item">
                                        <i class="bi bi-book text-info me-2"></i>
                                        <small>Full access to courses and assessments</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-item">
                                        <i class="bi bi-graph-up text-warning me-2"></i>
                                        <small>Performance tracking and analytics</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="actions mt-4">
                            <div class="d-flex flex-column flex-sm-row gap-3 justify-content-center">
                                <button onclick="checkApprovalStatus()" class="btn btn-primary">
                                    <i class="bi bi-arrow-clockwise me-2"></i>
                                    Check Status
                                </button>
                                
                                <a href="/auth/logout" class="btn btn-outline-secondary">
                                    <i class="bi bi-box-arrow-right me-2"></i>
                                    Sign Out
                                </a>
                            </div>
                        </div>

                        <!-- Contact Info -->
                        <div class="contact-info mt-4 pt-4 border-top">
                            <h6 class="fw-semibold mb-2">Need Help?</h6>
                            <p class="text-muted small mb-2">
                                If you have questions about your approval status, please contact:
                            </p>
                            <div class="contact-details">
                                <a href="mailto:admin@studenttracker.com" class="text-decoration-none me-3">
                                    <i class="bi bi-envelope me-1"></i>
                                    admin@studenttracker.com
                                </a>
                                <a href="tel:+1234567890" class="text-decoration-none">
                                    <i class="bi bi-telephone me-1"></i>
                                    +1 (234) 567-890
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Additional Info Card -->
                <div class="info-card card mt-4 border-0 bg-light">
                    <div class="card-body p-4">
                        <h6 class="fw-bold text-dark mb-3">
                            <i class="bi bi-lightbulb me-2"></i>
                            While You Wait
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="tip-item">
                                    <i class="bi bi-book text-primary mb-2" style="font-size: 1.5rem;"></i>
                                    <h6 class="fw-semibold">Explore Documentation</h6>
                                    <p class="text-muted small mb-0">
                                        Learn about the platform features and how to make the most of your account.
                                    </p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="tip-item">
                                    <i class="bi bi-person-check text-success mb-2" style="font-size: 1.5rem;"></i>
                                    <h6 class="fw-semibold">Complete Your Profile</h6>
                                    <p class="text-muted small mb-0">
                                        Once approved, you can update your profile with additional information.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.pending-container {
    background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
    position: relative;
}

.pending-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="clock" width="50" height="50" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="2" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23clock)"/></svg>');
    opacity: 0.3;
}

.pending-card {
    border-radius: 1rem;
    backdrop-filter: blur(10px);
    position: relative;
    z-index: 1;
    animation: fadeInUp 0.8s ease-out;
}

.pending-icon {
    position: relative;
    display: inline-block;
}

.icon-wrapper {
    position: relative;
    display: inline-block;
}

.pulse-ring {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100px;
    height: 100px;
    border: 3px solid #ffc107;
    border-radius: 50%;
    opacity: 0;
    animation: pulse 2s infinite;
}

.step {
    text-align: center;
}

.step-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
}

.info-item {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
}

.tip-item {
    text-align: center;
    padding: 1rem;
    border-radius: 0.5rem;
    background: white;
    transition: transform 0.3s ease;
}

.tip-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.user-info {
    border: 2px dashed #ffc107;
}

.contact-details a {
    color: #6c757d;
    transition: color 0.3s ease;
}

.contact-details a:hover {
    color: #0d6efd;
}

/* Animations */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes pulse {
    0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.5);
    }
    50% {
        opacity: 0.3;
        transform: translate(-50%, -50%) scale(1);
    }
    100% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(1.2);
    }
}

/* Auto-refresh indicator */
.refresh-indicator {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 0.5rem;
    padding: 0.5rem 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    z-index: 1000;
    animation: slideInRight 0.5s ease-out;
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* Responsive */
@media (max-width: 768px) {
    .pending-card {
        margin: 1rem;
    }
    
    .card-body {
        padding: 2rem !important;
    }
    
    .info-card {
        margin: 1rem;
    }
    
    .actions .btn {
        width: 100%;
    }
    
    .contact-details {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-refresh every 30 seconds to check for approval
    let refreshInterval;
    let refreshCount = 0;
    const maxRefreshes = 20; // Stop after 10 minutes
    
    function startAutoRefresh() {
        // Create refresh indicator
        const indicator = document.createElement('div');
        indicator.className = 'refresh-indicator';
        indicator.innerHTML = `
            <small class="text-muted">
                <i class="bi bi-arrow-clockwise me-1"></i>
                Auto-checking status...
            </small>
        `;
        document.body.appendChild(indicator);
        
        refreshInterval = setInterval(() => {
            refreshCount++;
            
            if (refreshCount >= maxRefreshes) {
                clearInterval(refreshInterval);
                indicator.innerHTML = `
                    <small class="text-muted">
                        <i class="bi bi-pause me-1"></i>
                        Auto-refresh paused
                    </small>
                `;
                return;
            }
            
            // Check approval status
            fetch('/api/auth/status')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.user.approval_status === 'approved') {
                        // Redirect to appropriate dashboard
                        window.location.href = `/${data.user.role}/dashboard`;
                    } else if (data.user.approval_status === 'rejected') {
                        // Show rejection message
                        window.location.href = '/auth/rejected';
                    }
                    
                    // Update indicator
                    indicator.innerHTML = `
                        <small class="text-muted">
                            <i class="bi bi-check me-1"></i>
                            Status checked (${refreshCount}/${maxRefreshes})
                        </small>
                    `;
                })
                .catch(error => {
                    console.error('Error checking status:', error);
                    indicator.innerHTML = `
                        <small class="text-danger">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            Check failed
                        </small>
                    `;
                });
        }, 30000); // 30 seconds
    }
    
    // Start auto-refresh after 5 seconds
    setTimeout(startAutoRefresh, 5000);
    
    // Manual status check
    window.checkApprovalStatus = function() {
        const btn = event.target;
        const originalText = btn.innerHTML;
        
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Checking...';
        btn.disabled = true;
        
        fetch('/api/auth/status')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.user.approval_status === 'approved') {
                        // Show success and redirect
                        btn.innerHTML = '<i class="bi bi-check me-2"></i>Approved!';
                        btn.className = 'btn btn-success';
                        
                        setTimeout(() => {
                            window.location.href = `/${data.user.role}/dashboard`;
                        }, 1500);
                    } else if (data.user.approval_status === 'rejected') {
                        btn.innerHTML = '<i class="bi bi-x me-2"></i>Rejected';
                        btn.className = 'btn btn-danger';
                        
                        setTimeout(() => {
                            window.location.href = '/auth/rejected';
                        }, 1500);
                    } else {
                        btn.innerHTML = '<i class="bi bi-clock me-2"></i>Still Pending';
                        btn.className = 'btn btn-warning';
                        
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.className = 'btn btn-primary';
                            btn.disabled = false;
                        }, 2000);
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                btn.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Error';
                btn.className = 'btn btn-danger';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.className = 'btn btn-primary';
                    btn.disabled = false;
                }, 2000);
            });
    };
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
    });
});
</script>

<%- include('partials/footer') %>

